name: Continuous Integration

on:
  push:
    paths-ignore:
      - "**/*.md"
    branches:
      - main
      - ci
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  RUSTC_WRAPPER: sccache
  RUSTFLAGS: -Dwarnings
  SCCACHE_GHA_ENABLED: 'true'

jobs:
  unused-dependencies:
    name: No unused dependencies
    runs-on: ubuntu-latest
    env:
      RUSTC_WRAPPER: null
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - run: rm rust-toolchain.toml
      - name: Install cargo-shear
        uses: taiki-e/install-action@v2.52.4
        with:
          tool: cargo-shear@1.3.0 # dep:cargo-bin:cargo-shear
      - run: cargo shear

  cache-rust-toolchain:
    name: Cache Rust toolchain
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: ./.github/actions/setup-rust
        with:
          lookup-only: 'true'

  check-targets:
    name: Check targets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version-file: .tool-versions
      - run: bun install --frozen-lockfile
      - run: bun run scripts/check-targets.ts

  config-codegen:
    name: Check config codegen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - run: cd vertx-config && sha512sum --status --check out/.hashes

  rustfmt:
    runs-on: ubuntu-latest
    needs: cache-rust-toolchain
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: ./.github/actions/setup-rust
      - run: cargo fmt --all --check

  # Only run for entrypoints; dependencies will be checked where they are used
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: cache-rust-toolchain
    strategy:
      fail-fast: false
      matrix:
        crate:
          - vertx-crsf
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - run: cargo clippy --all-targets -p ${{ matrix.crate }}

  clippy-config-migrate:
    name: Clippy (config-migrate)
    runs-on: ubuntu-latest
    needs: cache-rust-toolchain
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - run: cargo clippy -Zbuild-std=core --target wasm32-unknown-unknown -p vertx-config-migrate -F up
      - run: cargo clippy -Zbuild-std=core --target wasm32-unknown-unknown -p vertx-config-migrate -F down

  build-configurator:
    name: Build configurator
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: vertx-configurator
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version-file: .tool-versions
      - run: bun install --frozen-lockfile
      - run: bun run astro build
        env:
          NODE_ENV: production
      - run: bun run scripts/post-build.ts
      - uses: actions/upload-artifact@v4.6.2
        with:
          name: configurator
          path: out
          compression-level: 1
          if-no-files-found: error

  clippy-vertx:
    name: Clippy (vertx, ${{ matrix.target }})
    runs-on: ubuntu-latest
    needs: [cache-rust-toolchain, build-configurator]
    strategy:
      fail-fast: false
      matrix:
        target:
          - devkit-esp32s3
          - devkit-rp-pico
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version-file: .tool-versions
      - run: bun install --frozen-lockfile
      - name: Get pre-built configurator
        uses: actions/download-artifact@v4.3.0
        with:
          name: configurator
          path: out
      - name: Run clippy
        run: bun run scripts/build-target.ts --command=clippy --target=${{ matrix.target }}

  clippy-vertx-simulator:
    name: Clippy (vertx simulator)
    runs-on: ubuntu-latest
    needs: [cache-rust-toolchain, build-configurator]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - name: Run clippy
        run: cargo clippy -Zbuild-std=std,panic_abort --target wasm32-unknown-unknown --lib -F simulator
        working-directory: vertx

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: cache-rust-toolchain
    strategy:
      fail-fast: false
      matrix:
        crate:
          - vertx-crsf
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2.52.4
        with:
          tool: nextest@0.9.97 # dep:cargo-bin:cargo-nextest
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - run: cargo nextest run
        working-directory: ${{ matrix.crate }}

  build:
    name: Build (${{ matrix.target }})
    runs-on: ubuntu-latest
    needs: [cache-rust-toolchain, build-configurator]
    strategy:
      fail-fast: false
      matrix:
        target:
          - devkit-esp32s3
          - devkit-rp-pico
    env:
      VERTX_SKIP_CONFIGURATOR_BUILD: true
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version-file: .tool-versions
      - run: bun install --frozen-lockfile
      - name: Get pre-built configurator
        uses: actions/download-artifact@v4.3.0
        with:
          name: configurator
          path: out
      - name: Build
        run: bun run scripts/build-target.ts --target=${{ matrix.target }} --release
      - uses: actions/upload-artifact@v4.3.0
        with:
          name: vertx-${{ matrix.target }}
          path: out/firmware/vertx_${{ matrix.target }}_release
          if-no-files-found: error

  size:
    runs-on: ubuntu-latest
    if: always()
    needs: build
    steps:
      - uses: actions/download-artifact@v4.3.0
        with:
          pattern: vertx-*
          path: bins
          merge-multiple: true
      - run: |
          FLASH=(
            .boot2 .data .data.wifi .rodata .rodata.wifi
            .rwtext .rwtext.wifi .text .vector_table .vectors
          )

          echo '| Target | Approximate size |' >> "$GITHUB_STEP_SUMMARY"
          echo '| ------ | ----------------:|' >> "$GITHUB_STEP_SUMMARY"

          find bins -type f | while read -r elf; do
            total=0
            while read -r section size _; do
              for flash in "${FLASH[@]}"; do
                if [[ "$section" == "$flash" ]]; then
                  total=$((total + size))
                  break
                fi
              done
            done < <(size -A "$elf" | sed -E '/^$/d' | tail -n +3 | head -n -1)

            echo "| $(echo "$elf" | cut -d_ -f2- | cut -d_ -f-2) | $(numfmt --to=iec-i --suffix=B $total) |" >> "$GITHUB_STEP_SUMMARY"
          done

  tsc:
    name: TypeScript
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: [postcard-ts, scripts, vertx-config, vertx-config-migrate, vertx-configurator]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version-file: .tool-versions
      - run: bun install --frozen-lockfile
      - run: bun run astro check
        working-directory: ${{ matrix.dir }}
        if: ${{ matrix.dir == 'vertx-configurator' }}
      - run: bun run tsc
        working-directory: ${{ matrix.dir }}

  tsc-simulator:
    name: TypeScript (vertx-simulator)
    runs-on: ubuntu-latest
    needs: cache-rust-toolchain
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: mozilla-actions/sccache-action@v0.0.9
      - uses: ./.github/actions/setup-rust
      - uses: oven-sh/setup-bun@v2.0.2
        with:
          bun-version-file: .tool-versions
      - name: Install wasm-bindgen
        uses: taiki-e/install-action@v2.52.4
        with:
          tool: wasm-bindgen@0.2.100 # dep:cargo-bin:wasm-bindgen-cli
      - name: Install wasm-opt
        uses: taiki-e/install-action@v2.52.4
        with:
          tool: wasm-opt@0.116.1 # dep:cargo-bin:wasm-opt
      - run: bun install --frozen-lockfile
      - run: bun run scripts/build-simulator.ts
        env:
          VERTX_GIT_BRANCH: ${{ github.head_ref || github.ref_name }}
      - run: bun run tsc
        working-directory: vertx-simulator

  biome:
    name: Biome
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: [postcard-ts, scripts, vertx-config, vertx-config-migrate, vertx-configurator, vertx-simulator]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: biomejs/setup-biome@v2.5.0
        env:
          GITHUB_TOKEN: null
      - run: biome version
      - run: biome ci --reporter=github --error-on-warnings .
        working-directory: ${{ matrix.dir }}

  dprint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: dprint/check@v2.2
        with:
          dprint-version: 0.50.0 # dep:cargo-bin:dprint
          config-path: .config/dprint.json

  typos:
    name: Typos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - uses: crate-ci/typos@v1.32.0 # dep:asdf:typos

  passed:
    runs-on: ubuntu-latest
    needs:
      - unused-dependencies
      - check-targets
      - config-codegen
      - rustfmt
      - clippy
      - clippy-config-migrate
      - clippy-vertx
      - clippy-vertx-simulator
      - tests
      - build
      - tsc
      - tsc-simulator
      - biome
      - dprint
      - typos
    steps:
      - run: 'true'

version: "3"

dotenv:
  - .env
  - .env.target

vars:
  NIGHTLY: nightly-2024-06-08 # Sync with CI and scripts/set-target

tasks:
  default:
    cmds:
      - task --list-all --sort none
    silent: true

  clean:
    desc: Delete all build artifacts
    prompt: Delete all build artifacts?
    cmds:
      - cargo clean
      - cd vertx-configurator && rm -r dist

  fmt:
    desc: Format everything
    cmds:
      - cargo +{{.NIGHTLY}} fmt --all
      - cargo bin dprint fmt
      - bun run biome format --write .

  setup:
    desc: Setup needed after first clone and dependency updates
    cmds:
      - git config --local include.path ../.gitconfig
      - rustup toolchain install {{.NIGHTLY}} --profile minimal --component rustfmt clippy
      - rustup +{{.NIGHTLY}} target install thumbv6m-none-eabi
      - cargo bin --install
      - cargo bin --sync-aliases
      - cd vertx-configurator && bun install
      - cmd: echo
        silent: true
      - cmd: echo "Run `task target:set` to choose your hardware target"
        silent: true
      - cmd: echo "A complete list of targets can be printed by running \`task targets\`"
        silent: true

  target:list:
    cmds:
      - echo "Available targets:"
      - for: sources
        cmd: echo '* {{.ITEM | trimPrefix "vertx/targets/" | trimSuffix ".json"}}'
    sources:
      - vertx/targets/*
    status:
      - 'false'
    silent: true

  target:set:
    cmd: bun run scripts/set-target.ts
    silent: true

  all:check:
    cmds:
      - task: vertx:check
      - task: vertx:simulator:check
      - task: configurator:check:tsc
      - task: simulator:check
      - task: simulator-ipc:check
      - task: config:check
      - task: config-macros:check
      - task: crsf:check
      - task: scripts:check:tsc
      - bun run biome ci --error-on-warnings .

  all:test:
    cmds:
      - task: config:test
      - task: crsf:test

  flash:vertx:
    desc: Flash the most recently built firmware to the connected handset
    cmds:
      - cargo bin espflash flash --partition-table vertx/partitions.csv --flash-size 16mb --baud 460800 --monitor target/vertx

  flash:backpack:
    desc: Flash the most recently built backpack firmware
    cmds:
      - cargo bin espflash flash --baud 460800 --monitor target/vertx-backpack

  erase-config:
    desc: Erase the connected handset's config partition
    cmds:
      - cargo bin espflash erase-parts --partition-table vertx/partitions.csv config

  vertx:check:
    deps:
      - configurator:build
    cmds:
      - task: vertx:cargo
        vars:
          COMMAND: clippy

  vertx:build:
    deps:
      - configurator:build
    cmds:
      - task: vertx:cargo
        vars:
          COMMAND: build
      - task: vertx:post-build
        vars:
          PROFILE: debug

  vertx:build:release:
    deps:
      - configurator:build
    cmds:
      - task: vertx:cargo
        vars:
          COMMAND: build
          ARGS: --release
      - task: vertx:post-build
        vars:
          PROFILE: release

  vertx:cargo:
    internal: true
    dir: vertx
    requires:
      vars: [COMMAND, VERTX_RUST_TOOLCHAIN, VERTX_RUST_TARGET, VERTX_CHIP]
    cmds:
      - cargo +{{.VERTX_RUST_TOOLCHAIN}} {{.COMMAND}} -Zbuild-std=alloc,core --target {{.VERTX_RUST_TARGET}} --bin vertx -F chip-{{.VERTX_CHIP}} {{.ARGS}}

  vertx:post-build:
    internal: true
    requires:
      vars: [PROFILE, VERTX_RUST_TARGET]
    cmds:
      - cp target/{{.VERTX_RUST_TARGET}}/{{.PROFILE}}/vertx target/vertx
    silent: true

  vertx:simulator:check:
    desc: Check simulator build of VerTX firmware
    deps:
      - configurator:build
    cmds:
      - task: vertx:simulator:cargo
        vars:
          COMMAND: clippy

  vertx:simulator:build:
    desc: Build VerTX to run in the simulator. Handled automatically by simulator:build/run
    deps:
      - configurator:build
    cmds:
      - task: vertx:simulator:cargo
        vars:
          COMMAND: build

  vertx:simulator:cargo:
    internal: true
    dir: vertx
    requires:
      vars: [COMMAND]
    cmds:
      - cargo +{{.NIGHTLY}} {{.COMMAND}} --bin simulator -F simulator

  backpack:check:
    deps:
      - configurator:build
    cmds:
      - task: backpack:cargo
        vars:
          COMMAND: clippy

  backpack:build:
    deps:
      - configurator:build
    cmds:
      - task: backpack:cargo
        vars:
          COMMAND: build
      - task: backpack:post-build
        vars:
          PROFILE: debug

  backpack:build:release:
    deps:
      - configurator:build
    cmds:
      - task: backpack:cargo
        vars:
          COMMAND: build
          ARGS: --release
      - task: backpack:post-build
        vars:
          PROFILE: release

  backpack:cargo:
    internal: true
    dir: vertx-backpack
    requires:
      vars: [COMMAND, VERTX_BACKPACK_RUST_TOOLCHAIN, VERTX_BACKPACK_RUST_TARGET, VERTX_BACKPACK_CHIP]
    cmds:
      - cargo +{{.VERTX_BACKPACK_RUST_TOOLCHAIN}} {{.COMMAND}} -Zbuild-std=alloc,core --target {{.VERTX_BACKPACK_RUST_TARGET}} --bin vertx-backpack -F chip-{{.VERTX_BACKPACK_CHIP}} {{.ARGS}}

  backpack:post-build:
    internal: true
    requires:
      vars: [PROFILE, VERTX_BACKPACK_RUST_TARGET]
    cmds:
      - cp target/{{.VERTX_BACKPACK_RUST_TARGET}}/{{.PROFILE}}/vertx-backpack target/vertx-backpack
    silent: true

  configurator:dev:
    desc: Run a local dev server. Needs api:dev running
    dir: vertx-configurator
    cmds:
      - bun run vite

  configurator:check:
    cmds:
      - bun run biome ci vertx-configurator
      - task: configurator:check:tsc

  configurator:check:tsc:
    internal: true
    dir: vertx-configurator
    cmds:
      - bun run tsc
    sources:
      - ../bun.lockb
      - ../tsconfig.*
      - scripts/**/*
      - src/**/*
      - '*.config.*'
      - tsconfig.*

  configurator:build:
    dir: vertx-configurator
    deps:
      - configurator:check
    env:
      NODE_ENV: production
    cmds:
      - bun run vite build
      - bun run scripts/compress.ts
    sources:
      - package.json
      - bun.lockb
      - index.html
      - src/**/*
      - '*.config.*'
      - tsconfig.*
      - scripts/compress.ts
    generates:
      - dist/**/*

  configurator:preview:
    desc: Run a local server from built artifacts. Needs api:dev running
    dir: vertx-configurator
    deps:
      - configurator:build
    cmds:
      - bun run vite preview

  simulator:check:
    dir: vertx-simulator
    cmds:
      - cargo clippy

  simulator:build:
    dir: vertx-simulator
    deps:
      - vertx:simulator:build
    cmds:
      - cargo build

  simulator:run:
    dir: vertx-simulator
    deps:
      - vertx:simulator:build
    cmds:
      - cargo run

  simulator-ipc:check:
    dir: vertx-simulator-ipc
    cmds:
      - cargo clippy

  config:check:
    dir: vertx-config
    cmds:
      - cargo clippy --all-features

  config:test:
    dir: vertx-config
    cmds:
      - cargo bin cargo-nextest run --status-level=leak

  config-macros:check:
    dir: vertx-config-macros
    cmds:
      - cargo clippy

  crsf:check:
    dir: vertx-crsf
    cmds:
      - cargo clippy

  crsf:test:
    dir: vertx-crsf
    cmds:
      - cargo bin cargo-nextest run --status-level=leak

  scripts:check:
    cmds:
      - bun run biome ci scripts
      - task: scripts:check:tsc

  scripts:check:tsc:
    internal: true
    dir: scripts
    cmds:
      - bun run tsc
    sources:
      - ../bun.lockb
      - ../tsconfig.*
      - tsconfig.*
      - '**.ts'

